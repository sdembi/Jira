# Code Generated by Sidekick is for learning and experimentation purposes only.
name: Salesforce JIRA Integration 2

on:
  repository_dispatch:
    types: [jira-status-deployment-needed]

env:
  SALESFORCE_CLI_VERSION: latest
  NODE_VERSION: '18'
  SALESFORCE_USERNAME: ${{ secrets.SALESFORCE_USERNAME }}
  SALESFORCE_CLIENT_ID: ${{ secrets.SALESFORCE_CLIENT_ID }}
  SALESFORCE_INSTANCE_URL: ${{ secrets.SALESFORCE_INSTANCE_URL }}

jobs:
  salesforce-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install the SFDX CLI
        run: |
          npm install sfdx-cli --global

      - name: Setup JWT Key
        run: |
          echo "${{ secrets.SALESFORCE_JWT_KEY }}" > jwt.key
          chmod 600 jwt.key

      - name: Authenticate to Salesforce Org
        run: |
          sfdx force:auth:jwt:grant \
            --username ${{ env.SALESFORCE_USERNAME }} \
            --jwtkeyfile ./jwt.key \
            --clientid ${{ env.SALESFORCE_CLIENT_ID }} \
            --instanceurl ${{ env.SALESFORCE_INSTANCE_URL }} \
            --setdefaultusername

      - name: Extract JIRA Inputs
        id: extract-inputs
        run: |
          echo "jira_ticket_key=${{ github.event.client_payload.jira_ticket_key }}" >> $GITHUB_OUTPUT
          echo "salesforce_components=${{ github.event.client_payload.salesforce_components }}" >> $GITHUB_OUTPUT
          echo "component_types=${{ github.event.client_payload.component_types }}" >> $GITHUB_OUTPUT
          echo "sandbox_org=${{ github.event.client_payload.sandbox_org }}" >> $GITHUB_OUTPUT
          echo "jira_status=${{ github.event.client_payload.jira_status }}" >> $GITHUB_OUTPUT

          echo "Received from JIRA:"
          echo "- Ticket: ${{ github.event.client_payload.jira_ticket_key }}"
          echo "- Status: ${{ github.event.client_payload.jira_status }}"
          echo "- Components: ${{ github.event.client_payload.salesforce_components }}"
          echo "- Types: ${{ github.event.client_payload.component_types }}"
          echo "- Sandbox: ${{ github.event.client_payload.sandbox_org }}"

      - name: Check Deployment Status
        run: |
          if [ "${{ steps.extract-inputs.outputs.jira_status }}" != "deployment needed" ]; then
            echo "Workflow triggered but status is not 'deployment needed'"
            echo "Current status: ${{ steps.extract-inputs.outputs.jira_status }}"
            echo "Exiting workflow..."
            exit 0
          fi
          echo "Status confirmed as 'deployment needed' - proceeding with deployment"